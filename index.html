<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>InvestMate</title>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">

        <link href="styles/design.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <header class="navbar text-white text-center p-3 navbar-light">
            <div class="container">
                <img src="images/logo.png" alt="InvestMate Logo" style="max-height: 60px;">
                <p class="lead">Custom GPT-based, data-driven investment suggestions​</p>
            </div>
        </header>
        <div class="container-fluid content-row">
            <div class="container">
                <div class="row main-content">
                    <div class="col-md-6">
                        <div class="flip-card">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <!-- Your front content goes here -->
                                    <div class="form-section">
                                        <form class="form" onsubmit="handleSubmit(event)">
                                            <fieldset>
                                                <legend class="col-form-label col-md-6">CUSTOMER INFORMATION</legend>
                                                <div class="form-group">
                                                    <label>I want to achieve RM</label>
                                                    <input type="number" name="financial_goal" placeholder="300000" step="50000" required>
                                                </div>
                                                <div class="form-group">
                                                    <label>In</label>
                                                    <select name="duration" required>
                                                        <option value="3">3 Years</option>
                                                        <option value="5">5 Years</option>
                                                        <option value="10">10 Years</option>
                                                    </select>
                                                </div>

                                                <div class="form-group">
                                                    <label>Risk Level</label>
                                                    <select name="risk_level" required>
                                                        <option value="lowest">Lowest</option>
                                                        <option value="low">Low</option>
                                                        <option value="medium">Medium</option>
                                                        <option value="medium_to_high">Medium to High</option>
                                                        <option value="higher">Higher</option>
                                                        <option value="highest">Highest</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label>Monthly Income (RM) </label>
                                                    <input type="number" name="monthly_income" placeholder="7000" step="100" >
                                                </div>
                                                <div class="form-group">
                                                    <label>Monthly Savings (RM) </label>
                                                    <input type="number" name="monthly_savings" placeholder="2000" step="100" >
                                                </div>
                                            </fieldset>
                                            <br>
                                            <button type="submit">Get Investment Suggestions</button>
                                        </form>
                                        <div id="investment-tips-carousel" class="carousel slide mt-3" data-ride="carousel">
                                            <p class="lead">Tips from InvestMate</p>
                                            <div class="carousel-inner">
                                                <div class="carousel-item active">
                                                    <small class="text-muted"><strong>Start early: </strong> Starting your investment journey early can be incredibly beneficial. The earlier you begin, the more time your money has to grow</small>
                                                </div>
                                                <div class="carousel-item">
                                                    <small class="text-muted"><strong>Invest regularly: </strong>Even if you can only afford to invest a small amount each month, doing so consistently will help you reach your financial goals.</small>
                                                </div>
                                                <div class="carousel-item">
                                                    <small class="text-muted"><strong>Diversify your portfolio: </strong>Don't put all your eggs in one basket. Invest in a variety of asset classes to reduce your risk.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flip-card-back">
                                    <div class="row">
                                        <div class="col-md-10"><h4><strong>Data-driven investment suggestions​</strong></h4></div>
                                        <div class="col-md-2"><span class="close-btn">&times;</span></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <p><strong>Target Amount: </strong>RM <span class="text_target_amount"></span></p>
                                            <p><strong>Duration: </strong><span class="text_duration"></span> Years</p>
                                            <p><strong>Monthly Investment Needed: </strong>RM <span class="text_monthly_investment"></span></p>
                                            <hr>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <p><strong>Recommended portfolio for you to achieve your investment goal.</strong></p>
                                            <canvas id="allocationChart"></canvas>
                                            <p class="note">Note: You may customize the asset class allocation based on your needs and risk appetite.</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <canvas id="investmentChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 right-section">
                        <div class="output-section">
                            <p class="text-center text-dark lead" id="initial-help-text">
                                <img src="images/logo.png" alt="InvestMate Logo" style="max-height: 60px;"> <br>
                                <span>How can I help you today?</span>
                            </p>
                            <div id="output" class="output">
                                <div id="loader" class="loader" style="display: none;"></div>

                                <div id="chat-messages">
                                </div>

                            </div>

                            <div class="initial-prompts">
                                <a href="#link1" class="focus-link">What are the Hong Leong Bank investment Schemes?</a>
                                <a href="#link2" class="focus-link">What is Unit Trust?</a>
                                <a href="#link3" class="focus-link">Is there any Shariah-complaint investment schemes?</a>
                                <a href="#link4" class="focus-link">Suggest me some Low-risk options</a>
                            </div>
                            <div class="chat-input-container">
                                <div class="input-wrapper">
                                    <textarea id="userInput" class="form-control" placeholder="Ask InvestMate ..."></textarea>
                                    <button type="button" class="btn btn-primary messageInvestMate" onclick="handleUserInput()">Send</button>
                                </div>
                                <small class="text-center text-muted">InvestMate can make mistakes. Consider checking important information.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>

        <script type="text/javascript">
            var allocationChartInstance;
            const chatMessages = document.getElementById('chat-messages');
            var investmentChart;
            function flipCard() {
                var flipCardInner = document.querySelector('.flip-card-inner');
                flipCardInner.style.transform = 'rotateY(180deg)';
            }

            // Function to unflip the card
            function unflipCard() {
                var flipCardInner = document.querySelector('.flip-card-inner');
                flipCardInner.style.transform = '';
            }

            // Event listener for the close button
            document.querySelector('.close-btn').addEventListener('click', unflipCard);

            function handleSubmit(event) {
                event.preventDefault();

                const url = 'https://apitest.iqiglobal.com/api/v1/chats/calculate';

                const data = {
                    financial_goal: event.target.financial_goal.value,
                    duration: event.target.duration.value,
                    risk_level: event.target.risk_level.value,
                    monthly_savings: event.target.monthly_savings.value
                };
                const filteredData = Object.keys(data).reduce((acc, key) => {
                    if (data[key] !== '') {
                        acc[key] = data[key];
                    }
                    return acc;
                }, {});

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'n3@m0kh@0n@7f2!s0A16asdljasdaslsa8asdksd93234'
                    },
                    body: JSON.stringify(filteredData)
                })
                    .then(response => response.json())
                    .then(data => {
                        flipCard();
                        var allocationLabels = Object.keys(data.allocations);
                        var allocationPercentages = Object.values(data.allocations).map(function(value) {
                            return parseFloat(value);
                        });
                        drawAllocationCanvas(allocationLabels, allocationPercentages);

                        var labels = Object.keys(data.yearly_rot);
                        var worstData = labels.map(function(year) { return data.yearly_rot[year].worst; });
                        var avgData = labels.map(function(year) { return data.yearly_rot[year].avg; });
                        var bestData = labels.map(function(year) { return data.yearly_rot[year].best; });

                        drawYearlyReturnOnInvestment(labels, worstData, avgData, bestData);

                        var durationElement = document.querySelector('.text_duration');
                        if (durationElement) {
                            durationElement.textContent = data.duration;
                        }

                        var targetAmount = document.querySelector('.text_target_amount');
                        if (targetAmount) {
                            targetAmount.textContent = data.target_amount;
                        }

                        var textMonthlyInvestment = document.querySelector('.text_monthly_investment');
                        if (textMonthlyInvestment) {
                            textMonthlyInvestment.textContent = data.monthly_investment;
                        }
                        callInvestMe(data);
                    })
                    .catch(error => {
                        console.error(error);
                        loader.classList.remove('show'); // hide the loader
                    });
            }

            function appendMessage(role, message) {
                const messageElement = document.createElement('div');
                messageElement.classList.add(role);

                const iconSpan = document.createElement('span');

                // Choose the icon based on the role
                if (role === "user") {
                    iconSpan.innerHTML = '<i class="bi bi-person-fill me-2"></i>';
                } else {
                    iconSpan.innerHTML = '<i class="bi bi-robot me-2"></i> ';
                }

                const paragraph = document.createElement('span');
                paragraph.innerHTML = message; // Remember, sanitize if 'message' contains user-generated content

                // Append the icon and message to the messageElement container
                messageElement.appendChild(iconSpan);
                messageElement.appendChild(paragraph);

                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }


            function getLastBotMessage() {
                var botMessages = document.querySelectorAll('#output .botMessage');
                if (botMessages.length === 0) {
                    return null; // No bot messages found
                }
                return botMessages[botMessages.length - 1]; // Return the last bot message
            }

            function callInvestMe(params) {
                var initialPrompts = document.querySelector('.initial-prompts');
                initialPrompts.classList.add('d-none');


                const loader = document.getElementById('loader');
                const loaderContainer = document.querySelector('.output');

                loader.style.display = 'block';
                loaderContainer.classList.add('loading');

                var message = "Give me investment suggestions from Hong Leong Bank with following details: \n " +
                    "Financial Goal: " + params.target_amount + " RM, " +
                    "Duration: " + params.duration + " years, " +
                    "Monthly Investment: " + params.monthly_investment + " RM \n";

                appendMessage('user', message);

                var initialHelpText = document.getElementById('initial-help-text');
                initialHelpText.classList.add('d-none');

                const url = 'https://apitest.iqiglobal.com/api/v1/chats/investment';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'n3@m0kh@0n@7f2!s0A16asdljasdaslsa8asdksd93234'
                    },
                    body: JSON.stringify(params)
                })
                    .then(response => response.json())
                    .then(data => {
                        loader.style.display = 'none'; // hide loader
                        loaderContainer.classList.remove('loading');
                        let formattedMessage = data.message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        formattedMessage = formattedMessage.replace(/\n/g, '<br>');
                        console.log(formattedMessage);

                        appendMessage('assistant', formattedMessage);
                    })
                    .catch(error => {
                        console.error(error);
                        loader.classList.remove('show'); // hide the loader
                    });
            }

            function drawAllocationCanvas(labels, data) {
                var ctx = document.getElementById('allocationChart').getContext('2d');

                if (allocationChartInstance) {
                    allocationChartInstance.destroy();
                }

                allocationChartInstance = new Chart(ctx, {
                    type: 'pie', // or 'doughnut' for a doughnut chart
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Percentage Allocation',
                            data: data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',  // color for Mixed Asset
                                'rgba(54, 162, 235, 0.2)',  // color for Money Market Funds
                                'rgba(75, 192, 192, 0.2)'   // color for Equity
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        title: {
                            display: true,
                            text: 'Investment Allocation Percentages'
                        }
                    }
                });
            }

            function drawYearlyReturnOnInvestment(labels, worstData, avgData, bestData) {
                // Create the chart
                var ctx = document.getElementById('investmentChart').getContext('2d');
                if (investmentChart) {
                    investmentChart.destroy();
                }
                investmentChart = new Chart(ctx, {
                    type: 'line', // You can also choose 'bar' or other chart types
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Worst Case',
                                data: worstData,
                                borderColor: 'red',
                                fill: false
                            },
                            {
                                label: 'Average Case',
                                data: avgData,
                                borderColor: 'blue',
                                fill: false
                            },
                            {
                                label: 'Best Case',
                                data: bestData,
                                borderColor: 'green',
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        title: {
                            display: true,
                            text: 'Projected Investment Returns'
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: false,
                        },
                        hover: {
                            mode: 'nearest',
                            intersect: true
                        },
                        scales: {
                            x: {
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Year'
                                }
                            },
                            y: {
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Value (RM)'
                                }
                            }
                        }
                    }
                });
            }
            $(document).ready(function () {
                $('#investment-tips-carousel').carousel({
                    interval: 3000, // Adjust the interval (in milliseconds) for tip transitions
                    pause: 'hover' // Pause on hover
                });
            });

        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    </body>
</html>
